# ─────────────────────────────────────────────────────────────────────────────
# NBU Mental Health Platform — Nginx Virtual Host Config
# วางไฟล์นี้ที่: /etc/nginx/sites-available/nbu-mental-health.conf
#
# ขั้นตอน:
#   1. แทน mentalhealth.northbkk.ac.th ด้วย domain จริง (ถ้าต่างกัน)
#   2. sudo cp infra/nginx/nginx.conf /etc/nginx/sites-available/nbu-mental-health.conf
#   3. sudo ln -s /etc/nginx/sites-available/nbu-mental-health.conf \
#                 /etc/nginx/sites-enabled/nbu-mental-health.conf
#   4. sudo nginx -t
#   5. sudo certbot --nginx \
#        -d api.mentalhealth.northbkk.ac.th \
#        -d admin.mentalhealth.northbkk.ac.th \
#        -d liff.mentalhealth.northbkk.ac.th
#   6. sudo systemctl reload nginx
#
# หมายเหตุ: ไฟล์นี้ถูก include อยู่ใน http {} block ของ nginx.conf หลักอยู่แล้ว
#            ห้ามใส่ http {}, events {}, worker_processes ในไฟล์นี้
# ─────────────────────────────────────────────────────────────────────────────

# ── Rate limiting zones ────────────────────────────────────────────────────
# (ถ้า nginx.conf หลักมี zone ชื่อเดียวกันอยู่แล้ว ให้ลบบรรทัดเหล่านี้ออก)
limit_req_zone $binary_remote_addr zone=nbu_api:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=nbu_webhook:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=nbu_auth:10m rate=5r/m;

# ── Upstream definitions ───────────────────────────────────────────────────
upstream nbu_api_backend {
    server 127.0.0.1:3201;
    keepalive 32;
}

upstream nbu_admin_frontend {
    server 127.0.0.1:3202;
    keepalive 16;
}

upstream nbu_liff_frontend {
    server 127.0.0.1:3203;
    keepalive 16;
}

# ── HTTP → HTTPS redirect ──────────────────────────────────────────────────
server {
    listen 80;
    listen [::]:80;
    server_name api.mentalhealth.northbkk.ac.th
                admin.mentalhealth.northbkk.ac.th
                liff.mentalhealth.northbkk.ac.th;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ─────────────────────────────────────────────────────────────────────────────
# API: api.mentalhealth.northbkk.ac.th → port 3201
# ─────────────────────────────────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.mentalhealth.northbkk.ac.th;

    # SSL — certbot จะเพิ่ม/แก้ส่วนนี้อัตโนมัติ
    ssl_certificate     /etc/letsencrypt/live/mentalhealth.northbkk.ac.th/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mentalhealth.northbkk.ac.th/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:nbu_SSL:10m;
    ssl_session_timeout 10m;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header X-XSS-Protection "1; mode=block" always;

    client_max_body_size 2m;
    proxy_read_timeout   30s;
    proxy_send_timeout   30s;
    proxy_connect_timeout 5s;

    # LINE Webhook — rate limit สูง (LINE ส่งแบบ burst)
    location /webhooks/line {
        limit_req zone=nbu_webhook burst=50 nodelay;

        proxy_pass         http://nbu_api_backend;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
    }

    # Auth endpoints — rate limit เข้มงวด (ป้องกัน brute-force)
    location ~ ^/auth/(login|link-line-staff)$ {
        limit_req zone=nbu_auth burst=3 nodelay;

        proxy_pass         http://nbu_api_backend;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
    }

    # General API
    location / {
        limit_req zone=nbu_api burst=20 nodelay;

        proxy_pass         http://nbu_api_backend;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
    }
}

# ─────────────────────────────────────────────────────────────────────────────
# Admin Portal: admin.mentalhealth.northbkk.ac.th → port 3202
# ─────────────────────────────────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name admin.mentalhealth.northbkk.ac.th;

    ssl_certificate     /etc/letsencrypt/live/mentalhealth.northbkk.ac.th/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mentalhealth.northbkk.ac.th/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:nbu_SSL:10m;
    ssl_session_timeout 10m;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;

    client_max_body_size 5m;

    # Next.js static assets — cache นาน
    location /_next/static/ {
        proxy_pass       http://nbu_admin_frontend;
        add_header       Cache-Control "public, immutable, max-age=31536000";
        proxy_set_header Host $host;
    }

    location / {
        proxy_pass         http://nbu_admin_frontend;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
    }
}

# ─────────────────────────────────────────────────────────────────────────────
# LIFF App: liff.mentalhealth.northbkk.ac.th → port 3203
# ─────────────────────────────────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name liff.mentalhealth.northbkk.ac.th;

    ssl_certificate     /etc/letsencrypt/live/mentalhealth.northbkk.ac.th/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mentalhealth.northbkk.ac.th/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:nbu_SSL:10m;
    ssl_session_timeout 10m;

    # LIFF ต้องถูก embed ใน iframe จาก LINE — ห้ามใช้ DENY
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Content-Type-Options nosniff always;

    client_max_body_size 2m;

    location /_next/static/ {
        proxy_pass       http://nbu_liff_frontend;
        add_header       Cache-Control "public, immutable, max-age=31536000";
        proxy_set_header Host $host;
    }

    location / {
        proxy_pass         http://nbu_liff_frontend;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
    }
}
